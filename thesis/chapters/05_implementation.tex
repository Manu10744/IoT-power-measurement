\chapter{Implementation}\label{chapter:implementation}
The source code of the individual software components that have been implemented for the purpose of this work is stored in a GIT repository hosted by GitHub, which can be accessed via \url{https://github.com/Manu10744/esp32-edge-energy-measurement}. Next to miscellaneous scripts created for testing purposes, the repository contains the following directories which enclose the code and any dependencies of the respective core components:

\begin{enumerate}
    \item \textit{esp32-powermeter-udp-server}: Contains the source code of the software that is flashed to the ESP32 powermeter. The various parts of the powermeter's workload such as establishing a WiFi connection or carrying out the energy measurements for the individual edge devices as well as the utilized drivers for the INA3221 sensor and the SSD1306 OLED display used to visualize the latest individual measurements are outsourced into modular code packages which are located in the \usemintedstyle{bw}\mintinline{shell-session}|components| sub-directory. 
    
    The \usemintedstyle{bw}\mintinline{shell-session}|main| sub-directory includes \usemintedstyle{bw}\mintinline{shell-session}|main.c|, which represents the entrypoint of the software running on the powermeter. Here, the code from the submodules that were seperated out is imported in order to execute the respective tasks of the powermeter by starting a set of dedicated threads. Additionally, \usemintedstyle{bw}\mintinline{shell-session}|main.c| includes the code of the UDP server operated by the ESP32 powermeter.
    
    The project has been developed using the Espressif IoT Development Framework (ESP-IDF), which offers the possibility to build and deploy the software to an ESP32 micro-controller.
    
    \item \textit{powermeasurement-udp-client}: Includes the source code of the client application that was implemented for the purpose of retrieving specific energy measurement data from the ESP32 powermeter via UDP. 
    
    \begin{itemize}
        \item \usemintedstyle{bw}\mintinline{shell-session}|udp_client.c / udp_client.h|: The source files representing the entrypoint of the client application.
        \item \usemintedstyle{bw}\mintinline{shell-session}|powermeasurement.pb-c.c / powermeasurement.pb-c.h|: The source and header file of the code used to deserialize the Protocol Buffer messages that were received from the ESP32 powermeter. These files were generated by the \usemintedstyle{bw}\mintinline{shell-session}|protobuf-c| compiler.
        \item \usemintedstyle{bw}\mintinline{shell-session}|example.conf|: An exemplary power monitoring configuration file defining the energy measurement configuration for a set of sample devices.
        \item \usemintedstyle{bw}\mintinline{shell-session}|Makefile|: Automates the compilation and containerization process of the client application.
    \end{itemize}
    
    Moreover, there are the following sub-directories:
    \begin{itemize}
     \item \usemintedstyle{bw}\mintinline{shell-session}|docker|: Contains the \usemintedstyle{bw}\mintinline{shell-session}|Dockerfile| used for containerizing the application for various system architectures using Docker.
     \item \usemintedstyle{bw}\mintinline{shell-session}|deploy|: Provides exemplary deployment specifications for both the client application and the supplied exemplary configuration file. 
   \end{itemize}
    
    \item \textit{prometheus-power-exporter}: Incorporates the source code of the Prometheus exporter that was implemented in order to integrate the energy consumption monitoring of the individual edge systems into Prometheus.
    
    \begin{itemize}
        \item \usemintedstyle{bw}\mintinline{shell-session}|exporter.py|: The source file representing the entrypoint of the Prometheus exporter.
        \item \usemintedstyle{bw}\mintinline{shell-session}|power_metrics.py|: The source file defining the individual power-related metrics and the methods used to update them appropriately.
        \item \usemintedstyle{bw}\mintinline{shell-session}|powermeasurement.py|: The source file of the code used to deserialize the Protocol Buffer messages that were received from the UDP client application. This file was generated by the \usemintedstyle{bw}\mintinline{shell-session}|betterproto| compiler.
        \item \usemintedstyle{bw}\mintinline{shell-session}|requirements.txt|: Defines the software dependencies of the Prometheus exporter, which are installed using the Python package manager \usemintedstyle{bw}\mintinline{shell-session}|pip|.
        \item \usemintedstyle{bw}\mintinline{shell-session}|Makefile|: Automates the containerization process of the Prometheus exporter.
    \end{itemize}
    
    Additionally, the following sub-directories are included:
    \begin{itemize}
        \item \usemintedstyle{bw}\mintinline{shell-session}|docker|: Contains the \usemintedstyle{bw}\mintinline{shell-session}|Dockerfile| used for containerizing the application for various system architectures using Docker.
        \item \usemintedstyle{bw}\mintinline{shell-session}|deploy|: Includes exemplary files that can be used to deploy the Prometheus exporter to Kubernetes.
        \item \usemintedstyle{bw}\mintinline{shell-session}|dashboards|: Contains the source file of the Grafana dashboard which is tailored to the implemented Prometheus exporter.
    \end{itemize}
    
    \item \textit{protobuffers}: Contains \usemintedstyle{bw}\mintinline{shell-session}|powermeasurement.proto|, which stores the definition of the Protocol Buffer message that represents a power measurement carried out by the ESP32 powermeter.
    
    Moreover, a \usemintedstyle{bw}\mintinline{shell-session}|Makefile| is included which automates updating the Protocol Buffer message format by generating the code from \usemintedstyle{bw}\mintinline{shell-session}|powermeasurement.proto| using the respective compilers and copying the output files to the corresponding target directories of the respective sub-projects. 
    
    \item \textit{openfaas-functions}: Includes the source code of the Natural Language Processing application named \usemintedstyle{bw}\mintinline{shell-session}|analyze-sentence| which was designed as a serverless function that can be deployed to OpenFaaS.
    
    Furthermore, a sub-directory \usemintedstyle{bw}\mintinline{shell-session}|deploy| is included which provides an exemplary deployment file that can be used to deploy the function to OpenFaaS in Kubernetes.
\end{enumerate}

Additionally, each sub-directory contains a \usemintedstyle{bw}\mintinline{shell-session}|README.md| that provides a more detailed documentation about the functionality and usage of the respective component.


The actual Kubernetes deployment specifications of the complete cluster monitoring stack reside in another GIT repository which is accessible via \url{https://github.com/Function-Delivery-Network/kube-prometheus}.

The Docker images that have been created for the purpose of this work are organized in dedicated repositories, which are hosted by DockerHub. They can be accessed via the following URLs:

\begin{itemize}
    \item \url{https://hub.docker.com/repository/docker/phyz1x/prometheus-power-exporter}
    \item \url{https://hub.docker.com/repository/docker/phyz1x/powermeasurement-udp-client}
    \item \url{https://hub.docker.com/repository/docker/phyz1x/analyze-sentence}
\end{itemize}